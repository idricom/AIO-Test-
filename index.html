<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIO - ИИ Чат</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@heroicons/react/24/outline" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Segoe UI', Roboto, sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .hover-scale {
            transition: transform 0.2s ease;
        }
        .hover-scale:hover {
            transform: scale(1.1);
            cursor: pointer;
        }
        .sidebar {
            transition: width 0.3s ease;
        }
        .sidebar-collapsed {
            width: 60px !important;
        }
        .sidebar-collapsed .sidebar-content {
            display: none;
        }
        .typing {
            animation: typing 0.5s steps(30, end);
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900 dark:bg-gray-800 dark:text-white">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Config (INSERT YOUR FIREBASE CONFIG HERE)
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Main App Component
        const App = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [user, setUser] = useState(null);
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'system');
            const [history, setHistory] = useState(JSON.parse(localStorage.getItem('chatHistory')) || []);
            const [editingMessageId, setEditingMessageId] = useState(null);
            const [currentChatId, setCurrentChatId] = useState(null);
            const messagesEndRef = useRef(null);

            // Scroll to bottom when new messages are added
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Theme handling
            useEffect(() => {
                if (theme === 'dark') {
                    document.body.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            // Save history to localStorage
            useEffect(() => {
                localStorage.setItem('chatHistory', JSON.stringify(history));
            }, [history]);

            // Firebase Auth State
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user) {
                        setUser({
                            email: user.email,
                            avatar: user.photoURL || 'https://via.placeholder.com/40',
                        });
                    } else {
                        setUser(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Google Sign-In
            const handleGoogleSignIn = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch((error) => console.error('Google Sign-In Error:', error));
            };

            // Email Sign-In
            const handleEmailSignIn = (email, password) => {
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => console.error('Email Sign-In Error:', error));
            };

            // Email Sign-Up
            const handleEmailSignUp = (email, password) => {
                auth.createUserWithEmailAndPassword(email, password)
                    .catch((error) => console.error('Email Sign-Up Error:', error));
            };

            // API Key for Mistral AI (INSERT YOUR API KEY HERE)
            const MISTRAL_API_KEY = 'YOUR_MISTRAL_API_KEY';

            // Handle sending message to Mistral API
            const sendMessage = async (text) => {
                const newMessage = { id: Date.now(), role: 'user', content: text };
                setMessages((prev) => [...prev, newMessage]);

                const newChat = !currentChatId;
                const chatId = currentChatId || Date.now();
                if (newChat) {
                    setHistory((prev) => [
                        ...prev,
                        { id: chatId, title: text.slice(0, 30), messages: [newMessage], archived: false }
                    ]);
                    setCurrentChatId(chatId);
                } else {
                    setHistory((prev) =>
                        prev.map((chat) =>
                            chat.id === currentChatId
                                ? { ...chat, messages: [...chat.messages, newMessage] }
                                : chat
                        )
                    );
                }

                try {
                    const response = await axios.post(
                        'https://api.mistral.ai/v1/chat/completions',
                        {
                            model: 'mistral-small',
                            messages: [{ role: 'user', content: text }],
                        },
                        {
                            headers: {
                                Authorization: `Bearer ${MISTRAL_API_KEY}`,
                                'Content-Type': 'application/json',
                            },
                        }
                    );

                    const assistantMessage = {
                        id: Date.now() + 1,
                        role: 'assistant',
                        content: response.data.choices[0].message.content,
                    };
                    setMessages((prev) => [...prev, assistantMessage]);
                    setHistory((prev) =>
                        prev.map((chat) =>
                            chat.id === currentChatId
                                ? { ...chat, messages: [...chat.messages, assistantMessage] }
                                : chat
                        )
                    );

                    // Simulate typing animation
                    let content = '';
                    for (let char of assistantMessage.content) {
                        content += char;
                        setMessages((prev) =>
                            prev.map((msg) =>
                                msg.id === assistantMessage.id ? { ...msg, content } : msg
                            )
                        );
                        await new Promise((resolve) => setTimeout(resolve, 30));
                    }
                } catch (error) {
                    console.error('Ошибка получения ответа:', error);
                    const errorMessage = { id: Date.now() + 1, role: 'assistant', content: 'Ошибка получения ответа' };
                    setMessages((prev) => [...prev, errorMessage]);
                    setHistory((prev) =>
                        prev.map((chat) =>
                            chat.id === currentChatId
                                ? { ...chat, messages: [...chat.messages, errorMessage] }
                                : chat
                        )
                    );
                }
            };

            // Handle form submission
            const handleSubmit = (e) => {
                e.preventDefault();
                if (input.trim()) {
                    sendMessage(input);
                    setInput('');
                    setEditingMessageId(null);
                }
            };

            // Handle message editing
            const handleEdit = (id, content) => {
                setEditingMessageId(id);
                setInput(content);
            };

            // Handle message retry
            const handleRetry = (content) => {
                sendMessage(content);
            };

            // Handle copy to clipboard
            const handleCopy = (content) => {
                navigator.clipboard.writeText(content);
                alert('Скопировано!');
            };

            // Handle share
            const handleShare = (content) => {
                navigator.share?.({ text: content }) || alert('Поделиться не поддерживается');
            };

            // Handle chat actions
            const handleNewChat = () => {
                setMessages([]);
                setCurrentChatId(null);
            };

            const handleRenameChat = (chatId, newTitle) => {
                setHistory((prev) =>
                    prev.map((chat) =>
                        chat.id === chatId ? { ...chat, title: newTitle } : chat
                    )
                );
            };

            const handleDeleteChat = (chatId) => {
                setHistory((prev) => prev.filter((chat) => chat.id !== chatId));
                if (currentChatId === chatId) {
                    setMessages([]);
                    setCurrentChatId(null);
                }
            };

            const handleArchiveChat = (chatId) => {
                setHistory((prev) =>
                    prev.map((chat) =>
                        chat.id === chatId ? { ...chat, archived: !chat.archived } : chat
                    )
                );
            };

            const handleLoadChat = (chatId) => {
                const chat = history.find((c) => c.id === chatId);
                if (chat) {
                    setMessages(chat.messages);
                    setCurrentChatId(chatId);
                }
            };

            // Sidebar Component
            const Sidebar = () => (
                <div className={`fixed inset-y-0 left-0 w-64 glass-effect p-4 transition-transform transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 z-20 sidebar ${isSidebarCollapsed ? 'sidebar-collapsed' : ''}`}>
                    <div className="flex justify-between mb-4">
                        <button onClick={() => setIsSidebarOpen(false)} className="md:hidden hover-scale">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <button onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)} className="hover-scale">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                            </svg>
                        </button>
                    </div>
                    <div className="sidebar-content">
                        <button
                            onClick={handleNewChat}
                            className="w-full glass-effect p-2 rounded hover-scale flex justify-center"
                            title="Новый чат"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <div className="mt-4">
                            <h3 className="font-semibold flex items-center">
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                История
                            </h3>
                            {history.map((chat) => (
                                <div key={chat.id} className="flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded hover-scale">
                                    <button onClick={() => handleLoadChat(chat.id)} className="flex-1 text-left truncate">
                                        {chat.title}
                                    </button>
                                    <div className="relative">
                                        <button className="text-gray-400">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                            </svg>
                                        </button>
                                        <div className="absolute right-0 mt-2 w-48 glass-effect rounded shadow-lg hidden group-hover:block">
                                            <button
                                                onClick={() => {
                                                    const newTitle = prompt('Введите новое название:', chat.title);
                                                    if (newTitle) handleRenameChat(chat.id, newTitle);
                                                }}
                                                className="w-full text-left py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700"
                                            >
                                                Переименовать
                                            </button>
                                            <button
                                                onClick={() => handleDeleteChat(chat.id)}
                                                className="w-full text-left py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700"
                                            >
                                                Удалить
                                            </button>
                                            <button
                                                onClick={() => handleArchiveChat(chat.id)}
                                                className="w-full text-left py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700"
                                            >
                                                {chat.archived ? 'Разархивировать' : 'Архивировать'}
                                            </button>
                                            <button
                                                onClick={() => handleShare(chat.messages.map((m) => m.content).join('\n'))}
                                                className="w-full text-left py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700"
                                            >
                                                Подел invadedиться
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            // Auth Menu Component
            const AuthMenu = () => {
                const [showAuthModal, setShowAuthModal] = useState(false);
                const [isSignUp, setIsSignUp] = useState(false);
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');

                const handleAuthSubmit = (e) => {
                    e.preventDefault();
                    if (isSignUp) {
                        handleEmailSignUp(email, password);
                    } else {
                        handleEmailSignIn(email, password);
                    }
                    setShowAuthModal(false);
                    setEmail('');
                    setPassword('');
                };

                return (
                    <div className="relative">
                        {user ? (
                            <img
                                src={user.avatar}
                                alt="Пользователь"
                                className="w-8 h-8 rounded-full cursor-pointer hover-scale"
                            />
                        ) : (
                            <div className="space-x-2">
                                <button
                                    onClick={() => setShowAuthModal(true)}
                                    className="glass-effect px-3 py-1 rounded hover-scale text-sm"
                                >
                                    Войти
                                </button>
                                <button
                                    onClick={() => {
                                        setIsSignUp(true);
                                        setShowAuthModal(true);
                                    }}
                                    className="glass-effect px-3 py-1 rounded hover-scale text-sm"
                                >
                                    Зарегистрироваться
                                </button>
                            </div>
                        )}
                        {user && (
                            <div className="absolute right-0 mt-2 w-48 glass-effect rounded shadow-lg z-30">
                                <div className="p-2">
                                    <p className="truncate">{user.email}</p>
                                    <button
                                        onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
                                        className="w-full text-left py-1 hover:bg-gray-100 dark:hover:bg-gray-700"
                                    >
                                        Тема: {theme === 'dark' ? 'Тёмная' : 'Светлая'}
                                    </button>
                                    <button
                                        onClick={() => auth.signOut()}
                                        className="w-full text-left py-1 hover:bg-gray-100 dark:hover:bg-gray-700"
                                    >
                                        Выйти
                                    </button>
                                    <a href="mailto:support@aio.com" className="block py-1 hover:bg-gray-100 dark:hover:bg-gray-700">
                                        Связаться с нами
                                    </a>
                                    <a href="/premium" className="block py-1 hover:bg-gray-100 dark:hover:bg-gray-700">
                                        Премиум
                                    </a>
                                </div>
                            </div>
                        )}
                        {showAuthModal && (
                            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-40">
                                <div className="glass-effect p-6 rounded-lg max-w-sm w-full">
                                    <h2 className="text-lg font-bold mb-4">{isSignUp ? 'Регистрация' : 'Вход'}</h2>
                                    <button
                                        onClick={handleGoogleSignIn}
                                        className="w-full glass-effect p-2 rounded hover-scale mb-4 flex items-center justify-center"
                                    >
                                        <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M12.24 10.4V14h3.2c-.2 1-.8 1.8-1.6 2.4v2h2.6c1.5-1.4 2.4-3.4 2.4-5.8 0-.6 0-1.2-.2-1.8h-6.4zm-1.2-2.4H7.4v2.4H10c-.4.8-.6 1.6-.6 2.4 0 2.2 1.8 4 4 4 .8 0 1.6-.2 2.2-.6v-2.4c-.6.4-1.4.6-2.2.6-1.4 0-2.6-1-2.6-2.4 0-.8.2-1.6.6-2.4zm-5.6 0H3v2.4h2.4V8zm6-4.8c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8z"/>
                                        </svg>
                                        Войти через Google
                                    </button>
                                    <button
                                        className="w-full glass-effect p-2 rounded hover-scale mb-4 flex items-center justify-center"
                                        disabled
                                    >
                                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 12h14M12 5v14"></path>
                                        </svg>
                                        Войти через Яндекс
                                    </button>
                                    <form onSubmit={handleAuthSubmit}>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full p-2 mb-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                            placeholder="Email"
                                            required
                                        />
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full p-2 mb-2 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                            placeholder="Пароль"
                                            required
                                        />
                                        <button
                                            type="submit"
                                            className="w-full bg-blue-500 p-2 rounded hover:bg-blue-600 hover-scale"
                                        >
                                            {isSignUp ? 'Зарегистрироваться' : 'Войти'}
                                        </button>
                                    </form>
                                    <button
                                        onClick={() => setShowAuthModal(false)}
                                        className="mt-4 text-sm text-gray-500 hover:text-gray-700"
                                    >
                                        Закрыть
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="flex h-screen">
                    <Sidebar />
                    <div className="flex-1 flex flex-col">
                        <header className="glass-effect p-4 flex justify-between items-center">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden hover-scale">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <h1 className="text-xl font-bold">AIO</h1>
                            <AuthMenu />
                        </header>
                        <main className="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto">
                            {messages.map((msg) => (
                                <div
                                    key={msg.id}
                                    className={`mb-4 p-4 rounded-lg flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                >
                                    <div
                                        className={`max-w-[70%] p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'glass-effect typing'}`}
                                    >
                                        <p>{msg.content}</p>
                                        <div className="flex space-x-2 mt-2">
                                            <button onClick={() => handleRetry(msg.content)} className="hover-scale" title="Повторить">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h5m0 10v5h-5m10-20h5v5m-5 0h-5"></path>
                                                </svg>
                                            </button>
                                            {msg.role === 'user' && (
                                                <button onClick={() => handleEdit(msg.id, msg.content)} className="hover-scale" title="Редактировать">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                    </svg>
                                                </button>
                                            )}
                                            <button onClick={() => handleShare(msg.content)} className="hover-scale" title="Поделиться">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C9.375 12.37 10.626 12 12 12m0 0c1.374 0 2.625.37 3.316 1.342M12 12l9-5-9-5-9 5 9 5zm9-5v10l-9 5-9-5V7l9-5 9 5z"></path>
                                                </svg>
                                            </button>
                                            <button onClick={() => handleCopy(msg.content)} className="hover-scale" title="Копировать">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <div ref={messagesEndRef} />
                        </main>
                        <footer className="glass-effect p-4 max-w-3xl mx-auto">
                            <form onSubmit={handleSubmit} className="flex">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    className="flex-1 p-2 rounded-l bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                    placeholder="Введите сообщение..."
                                />
                                <button type="submit" className="bg-blue-500 p-2 rounded-r hover:bg-blue-600 hover-scale" title="Отправить">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </form>
                        </footer>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
